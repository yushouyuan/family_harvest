# 项目程序逻辑总结

## 项目概况
使用Django框架开发的家庭每日收获记录工具，支持四位预设家庭成员，提供文字+语音记录功能。

---

## 1. 项目启动流程
**首先执行的文件：** `manage.py`

```python
# 执行命令：python manage.py runserver
# 启动入口：manage.py 第17-18行
if __name__ == '__main__':
    main()
```

**启动流程：**
1. `main()` 函数设置环境变量 `DJANGO_SETTINGS_MODULE` 为 `family_harvest.settings`
2. 调用 `execute_from_command_line(sys.argv)` 启动Django服务器
3. 加载 `family_harvest/settings.py` 配置文件
4. 根据 `ROOT_URLCONF = 'family_harvest.urls'` 加载URL配置

---

## 2. URL路由配置
### 主路由配置（family_harvest/urls.py）
将所有根路径请求转发到 `harvest.urls`

### 应用路由配置（harvest/urls.py）
| URL路径 | 对应的视图函数 | 名称 |
|---------|--------------|------|
| `/login/` | `views.login_view` | `login` |
| `/logout/` | `views.logout_view` | `logout` |
| `/` | `views.index` | `index` |
| `/record/add/` | `views.add_or_edit_record` | `add_record` |
| `/record/<int:record_id>/edit/` | `views.add_or_edit_record` | `edit_record` |
| `/history/` | `views.history` | `history` |
| `/stats/` | `views.stats` | `stats` |

---

## 3. 核心功能流程

### 3.1 用户登录流程
1. 访问 `/login/` → 执行 `login_view` 函数
2. 页面显示所有家庭成员（从 `FamilyMember` 模型读取）
3. 用户选择成员提交 → 验证后将 `member_id` 和 `member_name` 存入 `session`
4. 重定向到 `/`（首页）

### 3.2 首页展示流程
1. 访问 `/` → 执行 `index` 函数（需要登录）
2. 读取当天日期和所有家庭成员
3. 查询当天所有成员的记录 → 按成员分组
4. 渲染 `index.html` 展示家庭汇总卡片

### 3.3 添加/编辑记录流程
1. 访问 `/record/add/` → 执行 `add_or_edit_record` 函数
2. 页面加载 `DailyRecordForm`，默认日期为当天
3. 用户填写文字或录制语音 → 提交表单
4. 验证表单 → 保存到 `DailyRecord` 模型
5. 重定向到首页

### 3.4 历史记录流程
1. 访问 `/history/` → 执行 `history` 函数
2. 查询所有记录并按日期倒序排列
3. 渲染 `history.html` 按时间线展示

---

## 4. 数据模型设计

### 4.1 FamilyMember（家庭成员）
```python
class FamilyMember(models.Model):
    username = models.CharField(max_length=32, unique=True)  # 用户名
    display_name = models.CharField(max_length=64)  # 显示名
    avatar = models.ImageField(upload_to='avatars/', null=True, blank=True)  # 头像
```
- 预设四个成员：爸爸、妈妈、哥哥、弟弟（通过 `create_members` 命令创建）

### 4.2 DailyRecord（每日记录）
```python
class DailyRecord(models.Model):
    member = models.ForeignKey(FamilyMember, on_delete=models.CASCADE)  # 关联成员
    date = models.DateField()  # 日期
    text = models.TextField(blank=True)  # 文字记录
    audio = models.FileField(upload_to='audio_records/', blank=True, null=True)  # 语音记录
    created_at = models.DateTimeField(auto_now_add=True)  # 创建时间

    class Meta:
        unique_together = ('member', 'date')  # 同一成员每日只能有一条记录
```

---

## 5. 语音录制功能
- 使用 `MediaRecorder API` 在前端浏览器录制语音
- 录制完成后将语音转换为 `Blob` 对象
- 通过表单提交到后端，保存为文件

---

## 6. 视图函数装饰器
```python
def require_login(view):
    def _wrapped(request, *args, **kwargs):
        if not request.session.get('member_id'):
            return redirect('login')
        request.member = get_object_or_404(FamilyMember, pk=member_id)
        return view(request, *args, **kwargs)
    return _wrapped
```
- 除了登录和注销，所有视图都需要登录才能访问
- 如果未登录，自动重定向到登录页 

---

## 7. 代码执行总结
```
Python manage.py runserver
↓
manage.py → family_harvest/settings.py
↓
family_harvest/urls.py → harvest/urls.py
↓
根据URL请求匹配到对应视图函数
    - login_view (登录页面)
    - index (首页)
    - add_or_edit_record (添加/编辑记录)
    - history (历史记录)
    - stats (统计信息)
↓
视图函数操作数据库模型获取/修改数据
↓
渲染Django模板返回HTML页面给用户
```
